---
# tasks file for stf-run-ci
- name: Setup default values
  set_fact:
    branch: "{{ working_branch | default('master') }}"
    namespace: "{{ working_namespace | default('service-telemetry') }}"

- name: Set default image paths for local builds
  set_fact:
    sgo_image_path: "{{ __internal_registry_path }}/{{ namespace }}/smart-gateway-operator:{{ sgo_image_tag }}"
    sto_image_path: "{{ __internal_registry_path }}/{{ namespace }}/service-telemetry-operator:{{ sto_image_tag }}"
    sg_core_image_path: "{{ __internal_registry_path }}/{{ namespace }}/sg-core:{{ sg_core_image_tag }}"
    sg_bridge_image_path: "{{ __internal_registry_path }}/{{ namespace }}/sg-bridge:{{ sg_bridge_image_tag }}"
    prometheus_webhook_snmp_image_path: "{{ __internal_registry_path }}/{{ namespace }}/prometheus-webhook-snmp:{{ prometheus_webhook_snmp_image_tag }}"

- name: Clean up any existing global artifacts
  include_tasks: pre-clean.yml

- name: Setup supporting Operator subscriptions
  include_tasks: setup_base.yml
  tags:
    - deploy

- name: Get new operator sdk
  when: __local_build_enabled | bool or __deploy_from_bundles_enabled | bool or __deploy_loki_enabled | bool
  command: ./get_new_operator_sdk.sh "{{ new_operator_sdk_version }}"

- when: __local_build_enabled | bool
  block:
  - name: Setup supporting repositories
    include_tasks: clone_repos.yml
    tags:
      - clone

  - name: Create base build list
    set_fact:
      build_list:
        - { name: service-telemetry-operator, dockerfile_path: build/Dockerfile, image_reference_name: sto_image_path, working_build_dir: ../ }
        - { name: smart-gateway-operator, dockerfile_path: build/Dockerfile, image_reference_name: sgo_image_path, working_build_dir: ./working/smart-gateway-operator }
        - { name: sg-core, dockerfile_path: build/Dockerfile, image_reference_name: sg_core_image_path, working_build_dir: ./working/sg-core }
        - { name: sg-bridge, dockerfile_path: build/Dockerfile, image_reference_name: sg_bridge_image_path, working_build_dir: ./working/sg-bridge }
        - { name: prometheus-webhook-snmp, dockerfile_path: Dockerfile, image_reference_name: prometheus_webhook_snmp_image_path, working_build_dir: ./working/prometheus-webhook-snmp }

  - debug:
     var: build_list

  - name: Create builds and artifacts
    include_tasks: create_builds.yml
    loop:
      - { name: service-telemetry-operator, dockerfile_path: build/Dockerfile, image_reference_name: sto_image_path, working_build_dir: ../ }
      - { name: smart-gateway-operator, dockerfile_path: build/Dockerfile, image_reference_name: sgo_image_path, working_build_dir: ./working/smart-gateway-operator }
      - { name: sg-core, dockerfile_path: build/Dockerfile, image_reference_name: sg_core_image_path, working_build_dir: ./working/sg-core }
      - { name: sg-bridge, dockerfile_path: build/Dockerfile, image_reference_name: sg_bridge_image_path, working_build_dir: ./working/sg-bridge }
      - { name: prometheus-webhook-snmp, dockerfile_path: Dockerfile, image_reference_name: prometheus_webhook_snmp_image_path, working_build_dir: ./working/prometheus-webhook-snmp }
    loop_control:
      loop_var: artifact
    tags:
      - build

  - name: Setup STF using local artifacts
    include_tasks: setup_stf_local_build.yml
    tags:
      - deploy

- block:
  - name: Setup Service Telemetry Framework from supplied bundle URLs
    include_tasks: setup_stf_from_bundles.yml
    when: __deploy_from_bundles_enabled | bool

  - name: Setup Service Telemetry Framework from application registry
    include_tasks: setup_stf.yml
    when: not __deploy_from_bundles_enabled | bool

  when: not __local_build_enabled | bool

- name: Pre-flight checks
  include_tasks: preflight_checks.yml

- block:
  - name: Deploy an instance of STF
    include_tasks: deploy_stf.yml

  - name: Validate system is operational
    shell: OCP_PROJECT="{{ namespace }}" ./validate_deployment.sh
    args:
      executable: /bin/bash
    register: validate_deployment

  - debug:
      var: validate_deployment.stdout_lines

  when: __deploy_stf | bool
