---
- name: Set default Smart Gateway Operator Subscription manifest
  when: smart_gateway_operator_subscription_manifest is not defined
  ansible.builtin.set_fact:
    smart_gateway_operator_subscription_manifest: |
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: smart-gateway-operator
        namespace: "{{ namespace }}"
      spec:
        channel: "{{ stf_channel }}"
        installPlanApproval: Automatic
        name: smart-gateway-operator
        source: "{{ infrawatch_operators }}"
        sourceNamespace: "{{ namespace }}"

- name: Set default Service Telemetry Operator Subscription manifest
  when: service_telemetry_operator_subscription_manifest is not defined
  ansible.builtin.set_fact:
    service_telemetry_operator_subscription_manifest: |
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: service-telemetry-operator
        namespace: "{{ namespace }}"
      spec:
        channel: "{{ stf_channel }}"
        installPlanApproval: Automatic
        name: service-telemetry-operator
        source: "{{ infrawatch_operators }}"
        sourceNamespace: "{{ namespace }}"

# subscribe to the Operators from the defined CatalogSource sources.
# STO will automatically install SGO via dependencies but pre-subscribe in case deployment from different CatalogSources is specified in an override (for testing purposes).
- name: Subscribe to Smart Gateway Operator
  kubernetes.core.k8s:
    definition:
      '{{ smart_gateway_operator_subscription_manifest }}'

- name: Subscribe to Service Telemetry Operator
  kubernetes.core.k8s:
    definition:
      '{{ service_telemetry_operator_subscription_manifest }}'
