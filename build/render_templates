#!/usr/bin/env bash
set -e
REL=$(dirname "$0")

# shellcheck source=build/metadata.sh
. "${REL}/metadata.sh"

RENDER=${RENDER:-true}
BUILD=${BUILD:-false}

generate_version() {
    echo "-- Generating operator version"
    UNIXDATE=$(date '+%s')
    OPERATOR_VERSION=${OPERATOR_CSV_MAJOR_VERSION}.${UNIXDATE}
    echo "---- Operator Version: ${OPERATOR_VERSION}"
}

create_working_dir() {
    echo "-- Create working directory"
    WORKING_DIR=${WORKING_DIR:-"/tmp/${OPERATOR_NAME}-bundle-${OPERATOR_VERSION}"}
    mkdir -p "${WORKING_DIR}"
    echo "---- Created working directory: ${WORKING_DIR}"
}

generate_dockerfile() {
    echo "-- Generate Dockerfile for bundle"
    sed -E "s/<<OPERATOR_VERSION>>/${OPERATOR_VERSION}/g" "${REL}/../${BUNDLE_PATH}/Dockerfile.in" > "${WORKING_DIR}/Dockerfile"
    echo "---- Generated Dockerfile complete"
}

generate_bundle() {
    echo "-- Generate bundle"
    REPLACE_REGEX="s#<<CREATED_DATE>>#${CREATED_DATE}#g;s#<<OPERATOR_IMAGE>>#${OPERATOR_IMAGE}#g;s#<<OPERATOR_TAG>>#${OPERATOR_TAG}#g;s#<<RELATED_IMAGE_PROMETHEUS_WEBHOOK_SNMP>>#${RELATED_IMAGE_PROMETHEUS_WEBHOOK_SNMP}#g;s#<<RELATED_IMAGE_PROMETHEUS_WEBHOOK_SNMP_TAG>>#${RELATED_IMAGE_PROMETHEUS_WEBHOOK_SNMP_TAG}#g;s#<<OPERATOR_VERSION>>#${OPERATOR_VERSION}#g;s#1.99.0#${OPERATOR_VERSION}#g"

    pushd "${REL}/../"
    echo "operator-sdk generate bundle --manifests --metadata --version ${OPERATOR_VERSION} --deploy-dir deploy/ --crds-dir deploy/crds/ --output-dir ${WORKING_DIR}"
    operator-sdk generate bundle --manifests --metadata --version "${OPERATOR_VERSION}" --deploy-dir deploy/ --crds-dir deploy/crds/ --output-dir "${WORKING_DIR}"
    popd

    echo "---- Replacing variables in generated manifest"
    sed -i -E "${REPLACE_REGEX}" "${WORKING_DIR}/manifests/${OPERATOR_NAME}.clusterserviceversion.yaml"
    echo "---- Generated bundle complete at ${WORKING_DIR}/manifests/${OPERATOR_NAME}.clusterserviceversion.yaml"
}

build_bundle() {
    echo "-- Build bundle"
    docker build -t "${OPERATOR_IMAGE}:${OPERATOR_VERSION}" -f "${WORKING_DIR}/Dockerfile" "${WORKING_DIR}"
    echo "---- Bundle build completed for ${OPERATOR_IMAGE}:${OPERATOR_VERSION}"
}


# generate templates
echo "## Begin bundle creation"
if [ "${RENDER}" = true ]; then
    generate_version
    create_working_dir
    generate_dockerfile
    generate_bundle
fi

if [ "${BUILD}" = true ]; then
    build_bundle
fi
echo "## End Bundle creation"
