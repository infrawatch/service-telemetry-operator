---
- job:
    name: stf-base
    # defined in: https://review.rdoproject.org/cgit/config/tree/zuul.d/_jobs-crc.yaml
    parent: base-simple-crc
    #This can't be used because the bundle can't be passed
    #parent: base-crc
    abstract: true
    description: |
      Run the stf-run-ci role, and then test stf
    roles:  # adds in dependent roles i.e. put it in the role path
      - zuul: github.com/openstack-k8s-operators/ci-framework
    # These are the additional repos that zuul will clone
    required-projects:
      - name: openstack-k8s-operators/ci-framework
        override-checkout: main
      - name: github.com/infrawatch/service-telemetry-operator
      - name: github.com/infrawatch/smart-gateway-operator
      - name: github.com/infrawatch/sg-bridge
      - name: github.com/infrawatch/sg-core
      - name: github.com/infrawatch/prometheus-webhook-snmp
    pre-run:
      - ci/prepare.yml
    run:
      - ci/deploy_stf.yml
      - ci/test_stf.yml
    post-run:
      - ci/post-collect_logs.yml
    nodeset: centos-9-crc-xxl
    # The default (~30 minutes) is not enough to run through all the job stages
    timeout: 3600
    vars:
      # Pass vars to crc cli https://review.rdoproject.org/cgit/config/tree/playbooks/crc/simple-start.yaml#n30
      crc_parameters: '--memory 16000 --disk-size 80 --cpus 6'  # Increase from 14336

  # this will go away eventually
- job:
    name: stf-multi-crc-base
    abstract: true
    description: |
      Temperory base job for crc jobs; the crc jobs will eventually use stf-base as a job, once PRs have merged
    parent: stf-base
    # Little hacky-hack so it won't complain about scenario not being defined.
    vars:
      scenario: "zuul-common"
    run:
      - ci/check_ocp_version.yml
    post-run:
      - ci/post-debug_crc.yml
      # Add these steps so we can work around the pre stage failing, and investigate whether CRC actually comes up, and whether it runs STF
      #- ci/prepare.yml
      #- ci/deploy_stf.yml
      #- ci/test_stf.yml
      - ci/post-collect_logs.yml
      - ci/post-upload_logs.yml

- job:
    name: stf-crc-nightly_bundles
    parent: stf-base
    abstract: true
    description: |
      Deploy STF using the nightly bundles
    vars:
      scenario: "nightly_bundles"

- job:
    name: stf-crc-local_build
    parent: stf-base
    abstract: true
    description: |
      Build images locally and deploy STF
    vars:
      scenario: "local_build"

- job:
    name: stf-crc-local_build-index_deploy
    parent: stf-base
    abstract: true
    description: |
      Build STF locally and deploy from index
    vars:
      scenario: "local_build-index_deploy"

- job:
    name: stf-crc-ocp_412-nightly_bundles
    parent: stf-crc-nightly_bundles
    description: |
      Deploy STF using the nightly bundles on OCP 4.12
    vars:
      crc_ocp_bundle: 'https://mirror.openshift.com/pub/openshift-v4/clients/crc/bundles/openshift/4.12.13/crc_libvirt_4.12.13_amd64.crcbundle'

- job:
    name: stf-crc-ocp_413-nightly_bundles
    parent: stf-crc-nightly_bundles
    description: |
      Deploy STF using the nightly bundles on OCP 4.13
    vars:
      crc_ocp_bundle: 'https://mirror.openshift.com/pub/openshift-v4/clients/crc/bundles/openshift/4.13.14/crc_libvirt_4.13.14_amd64.crcbundle'

- job:
    name: stf-crc-ocp_412-local_build
    parent: stf-crc-local_build
    description: |
      Build images locally and deploy STF on OCP 4.12
    vars:
      crc_ocp_bundle: 'https://mirror.openshift.com/pub/openshift-v4/clients/crc/bundles/openshift/4.12.13/crc_libvirt_4.12.13_amd64.crcbundle'

- job:
    name: stf-crc-ocp_413-local_build
    parent: stf-crc-local_build
    description: |
      Build images locally and deploy STF on OCP 4.13
    vars:
      crc_ocp_bundle: 'https://mirror.openshift.com/pub/openshift-v4/clients/crc/bundles/openshift/4.13.14/crc_libvirt_4.13.14_amd64.crcbundle'

- job:
    name: stf-crc-ocp_412-local_build-index_deploy
    parent: stf-crc-local_build-index_deploy
    description: |
      Build STF locally and deploy from index on OCP 4.12
    vars:
      crc_ocp_bundle: 'https://mirror.openshift.com/pub/openshift-v4/clients/crc/bundles/openshift/4.12.13/crc_libvirt_4.12.13_amd64.crcbundle'

- job:
    name: stf-crc-ocp_413-local_build-index_deploy
    parent: stf-crc-local_build-index_deploy
    description: |
      Build STF locally and deploy from index on OCP 4.13
    vars:
      crc_ocp_bundle: 'https://mirror.openshift.com/pub/openshift-v4/clients/crc/bundles/openshift/4.13.14/crc_libvirt_4.13.14_amd64.crcbundle'

- job:
    name: stf-crc-ocp414
    parent: stf-multi-crc-base
    nodeset: centos-9-crc-3xl
    vars:
      # get oc status took 25 attempts/2min 39 sec with 16GB ram
      # https://review.rdoproject.org/zuul/build/6162196471fe4db6891635f324eb8c30/console#4/1/4/controller
      # get oc status took 19 attempts/1m58sec
      # https://review.rdoproject.org/zuul/build/b2e3082a56ca43a5815acbe0c074b0eb/console#4/1/4/controller
      # crc_parameters: '--memory 20000 --disk-size 80 --cpus 8'
      # https://review.rdoproject.org/zuul/build/78feca3ce9e5495fbb3ebf811fabaa78/console#4/1/4/controller
      # 16 attempts/1m36s
      # crc_parameters: '--memory 25000 --disk-size 80 --cpus 8'
      # node only has 30GB
      # https://review.rdoproject.org/zuul/build/bc1b6c41fb1b47208958469bb39fa1f1/console
      crc_parameters: '--memory 30000 --disk-size 80 --cpus 8'
      crc_ocp_bundle: 'https://mirror.openshift.com/pub/openshift-v4/clients/crc/bundles/openshift/4.14.1/crc_libvirt_4.14.1_amd64.crcbundle'
      ocp_version: '4.14.1'

- project-template:
    name: stf-crc-jobs
    description: |
      STF CRC jobs that build and deploy STF
    github-check:
      jobs:
        - stf-crc-ocp_412-nightly_bundles
        - stf-crc-ocp_412-local_build
        - stf-crc-ocp_412-local_build-index_deploy
        - stf-crc-ocp_413-nightly_bundles
        - stf-crc-ocp_413-local_build
        - stf-crc-ocp_413-local_build-index_deploy
        
- project:
    name: infrawatch/service-telemetry-operator
    #templates:
    #  - stf-crc-jobs
    github-check:
      jobs:
        - stf-crc-ocp_413-nightly_bundles
        - stf-crc-ocp414
