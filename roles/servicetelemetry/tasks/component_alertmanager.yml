- name: Lookup template
  debug:
    msg: "{{ lookup('template', './manifest_alertmanager.j2') | from_yaml }}"

- name: Set default Alertmanager manifest
  set_fact:
    alertmanager_manifest: "{{ lookup('template', './manifest_alertmanager.j2') | from_yaml }}"
  when: alertmanager_manifest is not defined

- name: Set default Alertmanager configuration manifest
  set_fact:
    alertmanager_config_manifest: |
      apiVersion: v1
      kind: Secret
      metadata:
        name: 'alertmanager-{{ meta.name }}'
        namespace: '{{ meta.namespace }}'
      type: Opaque
      stringData:
        alertmanager.yaml: |-
          global:
            resolve_timeout: 5m
          route:
            group_by: ['job']
            group_wait: 30s
            group_interval: 5m
            repeat_interval: 12h
            receiver: 'null'
          receivers:
          - name: 'null'
  when: alertmanager_config_manifest is not defined

- name: Create an Alertmanager configuration secret
  k8s:
    state: '{{ "present" if servicetelemetry_vars.alerting.enabled else "absent" }}'
    definition:
      '{{ alertmanager_config_manifest }}'

- name: Create an instance of Alertmanager
  k8s:
    state: '{{ "present" if servicetelemetry_vars.alerting.enabled else "absent" }}'
    definition:
      '{{ alertmanager_manifest }}'
# TODO: Create route to access Alertmanager (conditional, default off)
