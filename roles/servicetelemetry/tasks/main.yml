---
- name: Installing service telemetry
  debug:
    msg: INSTALLING SERVICE TELEMETRY

# Default setup and platform querying
- name: Pre-setup
  include_tasks: pre.yml

# --> qdr
- name: Create QDR instance
  include_tasks: component_qdr.yml

# --> backends.metrics
- name: Create Prometheus instance
  include_tasks: component_prometheus.yml

# create Service Monitor instance
- name: Create Service Monitor instance
  include_tasks: component_servicemonitor.yml

# --> backends.events
- name: Check if we have elasticsearch CRD
  set_fact:
    has_elasticsearch_api: "{{ True if 'elasticsearch.k8s.elastic.co' in api_groups else False }}"

- name: Deploy ElasticSearch events backend
  block:
  - name: Setup Certificates for ElasticSearch
    include_tasks: component_certificates.yml

  - name: Setup ElasticSearch
    include_tasks: component_elasticsearch.yml
  when: has_elasticsearch_api | bool

# --> alerting
- name: Create Alertmanager instance
  include_tasks: component_alertmanager.yml

# --> backends.logs
- name: Create Loki instance
  include_tasks: component_loki.yml

# --> graphing
- name: Deploy graphing
  block:
  - name: Create Grafana instance
    include_tasks: component_grafana.yml

# --> clouds
- name: Get data about clouds
  debug:
    var: servicetelemetry_vars.clouds

- name: Loop through cloud instances to setup transport receivers
  include_tasks: component_clouds.yml
  loop: "{{ servicetelemetry_vars.clouds }}"
  loop_control:
    loop_var: this_cloud

# Post deployment tasks
- name: Post-setup
  include_tasks: post.yml
