- name: Lookup ElasticSearch BasicAuth
  k8s_info:
    api_version: v1
    kind: Secret
    namespace: '{{ meta.namespace }}'
    name: 'elasticsearch-es-elastic-user'
  register: elasticsearch_es_elastic_user

- name: Filter out ElasticSearch password for BasicAuth
  set_fact:
    elastic_pass: "{{ elasticsearch_es_elastic_user | json_query('resources[].data.elastic') | b64decode }}"
  no_log: true

- name: Deploy Events Smart Gateway instance for each agent
  vars:
    data_type: 'events'
    manifest: './manifest_smartgateway_events.j2'
  include_tasks: base_smartgateway.yml
  loop:
    - { name: 'Collectd', channel: 'collectd/notify'}
    - { name: 'Ceilometer', channel: 'anycast/ceilometer/event.sample'}
  loop_control:
    loop_var: agent
    label: "{{ agent.name }}"
